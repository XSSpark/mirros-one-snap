#!/bin/sh -e

# shellcheck source=src/mysql/scripts/mysql-utilities
. "$SNAP/scripts/mysql-utilities"

# Boot DB to ensure it's there
snapctl start mirros-one.mysql

counter=0
maxcounter=15

while [ ! -f "${RUNDIR}/mysqld.pid" ] && [ ! -S "${RUNDIR}/mysqld.sock" ]; do
  echo "waiting for mysqld"
  sleep 1
  counter=`expr $counter + 1`
  if [ $counter -gt $maxcounter ]; then
    echo "aborting wait after 15 seconds"
    exit 1
  fi
done

if set_root_password; then
  echo "mysql root password set to 'glancr'"
else
  echo "could not set well-known mysql root password, bailing"
  exit 1
fi

if mysql_test_connection; then
  echo "mysql connection test successful"
else
  echo "mysql connection test failed, bailing"
  exit 1
fi

# AP setup has to happen in configure hook since we do not have the required interfaces at this point.

# nginx setup. Limit substitution to prevent overwriting nginx variables.
mkdir -p "$SNAP_COMMON/nginx/tmp"
mkdir -p "$SNAP_COMMON/nginx/log"
envsubst '${SNAP} ${SNAP_NAME} ${SNAP_COMMON}' > "$SNAP_COMMON/nginx.conf" < "$SNAP/nginx.conf"

# Rails app setup
cp -r $SNAP/api/bundle_installed/* $SNAP_DATA/rails/.bundle
cp -r $SNAP/api/vendor_installed/* $SNAP_DATA/rails/vendor
cp -r $SNAP/api/db_installed/* $SNAP_DATA/rails/db
cat $SNAP/api/Gemfile_installed > $SNAP_DATA/rails/Gemfile
cat $SNAP/api/Gemfile.lock_installed > $SNAP_DATA/rails/Gemfile.lock

cd "$SNAP/api"
# Ensure that all commands are run in prod environment.
export RAILS_ENV=production

# Generates an individual secret for each snap installation. Environment variables set here might not be present at all times across revisions, so we store it in a file. TODO: Check if we can leverage snap configuration.
"$SNAP/wrapper" "$SNAP/api/bin/rails" secret > "$SNAP_DATA/secret"
SECRET_KEY_BASE=$(cat "${SNAP_DATA}/secret")
export SECRET_KEY_BASE

# FIXME: This installs the Openweathermap cities table. Make more generic for other default widgets.
"$SNAP/wrapper" "$SNAP/api/bin/rails" openweathermap:install:migrations

# Set up the API database.
"$SNAP/wrapper" "$SNAP/api/bin/rails" db:create db:migrate db:seed

# Disables the DNS service to prevent it from starting automatically.
# FIXME: Remove once https://github.com/snapcore/snapd/pull/5777 is in stable
snapctl stop --disable mirros-one.dns
